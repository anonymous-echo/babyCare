# 微信云托管部署指南

微信云托管（WeChat Cloud Hosting）是基于容器的云原生部署方案，特别适合微信小程序项目。它自带免鉴权、免备案域名和 HTTPS 环境。

## 1. 准备工作

1. 进入 [微信云托管控制台](https://cloud.weixin.qq.com/)。
2. 使用你的小程序管理员微信扫码登录。
3. 开通环境（新用户通常有 3 个月免费额度，无需绑卡，微信支付结算）。

## 2. 部署数据库 (PostgreSQL)

1. 在左侧菜单点击 **数据库**。
2. 创建一个 **PostgreSQL 实例**。
3. 创建完成后，记录 **内网连接地址**（Endpoint）、端口、用户名和密码。

## 3. 部署后端服务

1. 点击 **服务管理** -> **创建服务**。
2. 服务名称建议：`baby-server`。
3. **部署方式**：选择 **代码库部署**（需关联 GitHub/Gitee）或 **本地上传**。
4. **根目录** 设置为 `nutri-baby-server`。
5. **端口** 设置为 `8080`。
6. **环境变量配置**：
    - 在服务设置中填入对应的数据库、Redis 连接信息。
    - **注意**：由于在云托管内部，请使用内网地址以获得最快速度和最高安全性。
7. **发布单**：点击发布，云托管会自动根据项目中的 `Dockerfile` 进行构件并部署。

## 4. 部署 Redis (可选)

微信云托管暂不直接提供原生 Redis 托管，你有两种方案：
1. **容器自建**：利用云托管创建一个新服务跑 Redis 容器。
2. **外部接入**：接入外部（如腾讯云 Redis）的内网私有网络。
*对于初期小型项目，若只用于缓存，可以先在后端代码中使用内存缓存或通过容器自建。*

## 5. 小程序端调用

1. **安装 SDK**：
   ```bash
   npm install @wx-cloud/cloudproxy
   ```
2. **免鉴权调用**：
   在小程序中直接使用微信提供的 API：
   ```javascript
   wx.cloud.callContainer({
     "config": {
       "env": "你的环境ID"
     },
     "path": "/api/v1/user/info",
     "header": {
       "X-WX-SERVICE": "baby-server"
     },
     "method": "POST",
     "data": { ... }
   })
   ```
   **优势**：无需域名，无需备案，自动携带微信用户信息。

## 6. H5 访问

1. 在服务详情页面，开启 **公网域名访问**。
2. 云托管会为你生成一个长域名，直接作为前端 H5 的后端 API 地址。

## 优势总结
- **小程序直连**：省去了复杂的登录态（wx.login）转换逻辑。
- **免备案**：直接提供可拉起小程序的 HTTPS 链接。
- **冷启动降至0**：流量低时实例数可缩容至0，最大限度节省费用。
