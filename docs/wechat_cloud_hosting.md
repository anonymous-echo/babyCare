# 微信云托管部署指南

微信云托管（WeChat Cloud Hosting）是基于容器的云原生部署方案，特别适合微信小程序项目。它自带免鉴权、免备案域名和 HTTPS 环境。

## 1. 准备工作

1. 进入 [微信云托管控制台](https://cloud.weixin.qq.com/)。
2. 使用你的小程序管理员微信扫码登录。
3. 开通环境（新用户通常有 3 个月免费额度，无需绑卡，微信支付结算）。

## 2. 部署数据库 (PostgreSQL)

1. 在左侧菜单点击 **数据库**。
2. 创建一个 **PostgreSQL 实例**。
3. 创建完成后，记录 **内网连接地址**（Endpoint）、端口、用户名和密码。

## 3. 一键部署全栈服务 (推荐)

借助项目根目录下的统一 `Dockerfile`，你可以将前端 H5 和 Go 后端打包在一起部署。

### 部署步骤

1. 点击 **服务管理** -> **创建服务**。
2. 服务名称建议：`baby-app`。
3. **部署方式**：选择 **代码库部署**（推荐关联 GitHub）。
4. **服务设置**：
    - **端口**: 设置为 `80` (必须与 Dockerfile 中的 `EXPOSE` 保持一致)。
    - **目标目录**: 留空（代表项目根目录）。
    - **Dockerfile 名称**: `Dockerfile`。
5. **环境变量**:
    - 点击 **高级设置** -> **环境变量**。
    - 添加数据库和 Redis 的连接信息（使用内网 Endpoint）。
    - 建议添加 `GIN_MODE=release`。
6. **发布**: 点击发布。云托管会自动构建镜像并上线。

## 4. 为什么要在云托管使用统一部署？

1. **解决 404**：Go 后端已经内置了单页应用路由支持，即使在 H5 页面刷新也不会报错。
2. **免域名/免备案**：云托管提供的公网域名可以直接访问全栈应用。
3. **资源节省**：只需运行一个容器服务，充分利用微信云托管的免费额度。

## 4. 部署 Redis (可选)

微信云托管暂不直接提供原生 Redis 托管，你有两种方案：
1. **容器自建**：利用云托管创建一个新服务跑 Redis 容器。
2. **外部接入**：接入外部（如腾讯云 Redis）的内网私有网络。
*对于初期小型项目，若只用于缓存，可以先在后端代码中使用内存缓存或通过容器自建。*

## 5. 小程序端调用

1. **安装 SDK**：
   ```bash
   npm install @wx-cloud/cloudproxy
   ```
2. **免鉴权调用**：
   在小程序中直接使用微信提供的 API：
   ```javascript
   wx.cloud.callContainer({
     "config": {
       "env": "你的环境ID"
     },
     "path": "/api/v1/user/info",
     "header": {
       "X-WX-SERVICE": "baby-server"
     },
     "method": "POST",
     "data": { ... }
   })
   ```
   **优势**：无需域名，无需备案，自动携带微信用户信息。

## 6. H5 访问

1. 在服务详情页面，开启 **公网域名访问**。
2. 云托管会为你生成一个长域名，直接作为前端 H5 的后端 API 地址。

## 优势总结
- **小程序直连**：省去了复杂的登录态（wx.login）转换逻辑。
- **免备案**：直接提供可拉起小程序的 HTTPS 链接。
- **冷启动降至0**：流量低时实例数可缩容至0，最大限度节省费用。
